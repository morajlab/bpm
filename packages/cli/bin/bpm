#!/usr/bin/env bash

# Import bash modules
# TODO: import log module
# log=$(bpm import log)
log=echo

# Private functions
__find_bash_modules() {
  local root_path=
  local current_path=$(pwd)
  local is_root=false

  while ! $is_root; do
    if [ $current_path = / ]; then
      $log error 'bash modules are not installed.'
      exit 1
    fi

    if [ -d "$current_path/bash_modules" ]; then
      root_path="$current_path/bash_modules"
      is_root=true
    fi

    current_path=$(dirname $current_path)
  done

  echo "$root_path"
}

# Public functions
install() {
  local bin_path=$(pwd)/bash_modules/bin
  local packages=()

  shift

  while [ "$#" -gt 0 ]; do
    case "${1^^}" in
      "--GLOBAL" | "-G")
        bin_path=$HOME/.bash_modules/bin

        shift
      ;;
      *)
        packages+=("$1")

        shift
      ;;
    esac
  done

  mkdir -p $bin_path

  for p in "${packages[@]}"; do
    (
     curl -Lfs -o $bin_path/$p \
     https://raw.githubusercontent.com/morajlab/bash-scripts/master/packages/$p/bin/$p || \
     $log error "bash module '$p' doesn't exist."
    )
  done

  chmod u+x $bin_path -R
}
i() {
  install "$@"
}

import() {
  local bash_modules=$(__find_bash_modules)

  if [ "$?" != "0" ]; then
    echo "$bash_modules"
    exit 1
  fi

  shift

  echo "bash $bash_modules/bin/$1"
}

if [[ $1 = __* ]] || [ "$(type -t $1)" != 'function' ]; then
  $log error "argument '$1' is invalid."
  exit 1
fi

$1 "$@"
